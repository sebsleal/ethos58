/**
 * Ethanol blend math for Ethos85.
 *
 * Solves a two-fuel mixing problem:
 *   We have `current_gallons` of fuel at `current_ethanol_percent` (e.g. E10).
 *   We want to reach `target_ethanol_percent` in a `tank_size` tank.
 *   We add E85 (85% ethanol) and/or 93-octane pump gas (0% ethanol).
 *
 * Core equation (filling the tank to capacity):
 *   (current_gallons * ce + e85 * 0.85) / tank_size = target_ethanol_percent / 100
 *
 * Solving for e85:
 *   e85 = (tank_size * te/100 - current_gallons * ce/100) / 0.85
 *
 * Precision mode: returns 3-decimal accuracy and staged fill steps to help
 * avoid pump overshoot (a real-world problem when filling in small increments).
 */

/**
 * @param {object} params
 * @param {number}  params.current_gallons
 * @param {number}  params.current_ethanol_percent
 * @param {number}  params.target_ethanol_percent
 * @param {number}  params.tank_size
 * @param {boolean} [params.precision_mode=false]
 */
export function calculateBlend({
  current_gallons,
  current_ethanol_percent,
  target_ethanol_percent,
  tank_size,
  precision_mode = false,
}) {
  const warnings = [];

  const g  = parseFloat(current_gallons);
  const ce = parseFloat(current_ethanol_percent);
  const te = parseFloat(target_ethanol_percent);
  const ts = parseFloat(tank_size);

  if ([g, ce, te, ts].some(isNaN)) {
    throw new Error('All inputs must be valid numbers.');
  }
  if (g < 0 || g > ts)     throw new Error('current_gallons must be between 0 and tank_size.');
  if (ce < 0 || ce > 100)  throw new Error('current_ethanol_percent must be 0–100.');
  if (te < 0 || te > 85)   throw new Error('target_ethanol_percent must be 0–85 (E85 ceiling).');
  if (ts <= 0)              throw new Error('tank_size must be greater than 0.');

  const availableSpace        = ts - g;
  const currentEthanolGallons = g * (ce / 100);
  const targetEthanolGallons  = ts * (te / 100);

  // Ideal E85 gallons to hit target when filling to tank_size
  let e85Raw = (targetEthanolGallons - currentEthanolGallons) / 0.85;
  let e85    = Math.max(0, Math.min(e85Raw, availableSpace));
  let gas    = Math.max(0, availableSpace - e85);

  if (e85Raw < 0) {
    warnings.push('Target ethanol is below what 93-octane dilution alone can achieve. Drain some fuel first.');
    e85 = 0;
    gas = availableSpace;
  }

  if (e85Raw > availableSpace) {
    warnings.push('Target ethanol % cannot be reached without draining the tank — E85 capped at available space.');
    e85 = availableSpace;
    gas = 0;
  }

  const totalFuel        = g + e85 + gas;
  const totalEthanol     = currentEthanolGallons + e85 * 0.85;
  const resultingPercent = totalFuel > 0 ? (totalEthanol / totalFuel) * 100 : 0;

  // Standard output: 2 decimal places on gallons, 1 on percent
  const galDec     = precision_mode ? 3 : 2;
  const pctDec     = precision_mode ? 2 : 1;

  const result = {
    gallons_of_e85_to_add: round(e85, galDec),
    gallons_of_93_to_add:  round(gas, galDec),
    resulting_percent:     round(resultingPercent, pctDec),
    precision_mode:        precision_mode,
    warnings,
  };

  // Precision mode: add staged fill steps to prevent pump overshoot
  if (precision_mode && e85 > 0) {
    // Fill E85 in two stages: 80% first, pause and check, then the final 20%
    const stage1 = round(e85 * 0.8, 3);
    const stage2 = round(e85 - stage1, 3);

    // What is the blend after stage 1 only (no gas yet)?
    const ethanolAfterStage1 = currentEthanolGallons + stage1 * 0.85;
    const gallonsAfterStage1 = g + stage1;
    const percentAfterStage1 = round((ethanolAfterStage1 / gallonsAfterStage1) * 100, 2);

    result.fill_steps = [
      {
        step: 1,
        action: 'E85',
        gallons: stage1,
        note: `Add ${stage1} gal E85. Blend will be ~E${percentAfterStage1} at this point.`,
      },
      {
        step: 2,
        action: 'E85',
        gallons: stage2,
        note: `Add final ${stage2} gal E85 slowly to avoid overshoot.`,
      },
      ...(gas > 0 ? [{
        step: 3,
        action: '93-octane',
        gallons: round(gas, 3),
        note: `Fill ${round(gas, 3)} gal 93-octane to top off.`,
      }] : []),
    ];

    result.precision_note = 'Fill E85 in two stages to avoid pump overshoot. Final blend is sensitive to the last 20% of E85 added.';
  }

  return result;
}

function round(value, decimals) {
  return parseFloat(value.toFixed(decimals));
}
